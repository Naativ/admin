{"remainingRequest":"/Users/narfdre/Code/hexly/admin/node_modules/babel-loader/lib/index.js!/Users/narfdre/Code/hexly/admin/node_modules/cache-loader/dist/cjs.js??ref--0-0!/Users/narfdre/Code/hexly/admin/node_modules/vue-loader/lib/index.js??vue-loader-options!/Users/narfdre/Code/hexly/admin/src/components/ChangeSponsorDialog.vue?vue&type=script&lang=js&","dependencies":[{"path":"/Users/narfdre/Code/hexly/admin/src/components/ChangeSponsorDialog.vue","mtime":1577329618149},{"path":"/Users/narfdre/Code/hexly/admin/.babelrc","mtime":1546923832000},{"path":"/Users/narfdre/Code/hexly/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/narfdre/Code/hexly/admin/node_modules/babel-loader/lib/index.js","mtime":499162500000},{"path":"/Users/narfdre/Code/hexly/admin/node_modules/cache-loader/dist/cjs.js","mtime":499162500000},{"path":"/Users/narfdre/Code/hexly/admin/node_modules/vue-loader/lib/index.js","mtime":499162500000}],"contextDependencies":[],"result":["import \"regenerator-runtime/runtime\";\nimport _asyncToGenerator from \"/Users/narfdre/Code/hexly/admin/node_modules/@babel/runtime-corejs2/helpers/esm/asyncToGenerator\";\nimport \"core-js/modules/es6.array.find-index\";\nimport _objectSpread from \"/Users/narfdre/Code/hexly/admin/node_modules/@babel/runtime-corejs2/helpers/esm/objectSpread\";\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nimport MemberSearch from '@/components/MemberSearch';\nimport { Drag, Drop } from 'vue-drag-drop';\nimport CHANGE_SPONSOR from '@/graphql/ChangeSponsor.gql';\nvar defaultData = {\n  id: 2,\n  selected: [],\n  over: undefined,\n  snackbar: {\n    show: false,\n    message: undefined\n  },\n  locked: false,\n  dragging: false,\n  error: false\n};\nexport default {\n  props: {\n    showing: Boolean,\n    defaultMember: Object\n  },\n  name: 'SponsorDialog',\n  components: {\n    MemberSearch: MemberSearch,\n    Drag: Drag,\n    Drop: Drop\n  },\n  data: function data() {\n    return _objectSpread({}, defaultData, {\n      headers: [{\n        text: 'ID',\n        value: 'id'\n      }, {\n        text: 'Member',\n        value: 'displayName'\n      }, {\n        text: 'Current Sponsor',\n        value: 'currentSponsor'\n      }, {\n        text: 'New Sponsor',\n        value: 'newSponsor'\n      }, {\n        text: '',\n        value: 'actions'\n      }]\n    });\n  },\n  methods: {\n    emitDragging: function emitDragging(e) {\n      this.error = false;\n      this.dragging = true;\n    },\n    emitDraggingStop: function emitDraggingStop(e) {\n      this.dragging = false;\n    },\n    handleDrop: function handleDrop(data) {\n      var _this = this;\n\n      var idx = this.selected.findIndex(function (e) {\n        return e.id === _this.over;\n      });\n      this.over = undefined;\n\n      var updated = _objectSpread({}, this.selected[idx], {\n        newSponsor: data.member\n      });\n\n      this.selected.splice(idx, 1, updated);\n    },\n    childSelected: function childSelected(_ref) {\n      var member = _ref.member;\n      this.over = undefined;\n      var sponsor = null;\n\n      if (member && member.upline && member.upline.length > 1) {\n        sponsor = member.upline[member.upline.length - 2];\n      }\n\n      this.selected.push({\n        id: this.id++,\n        member: member,\n        sponsor: sponsor,\n        newSponsor: undefined\n      });\n    },\n    childRemoved: function childRemoved(_ref2) {\n      var id = _ref2.id;\n      var idx = this.selected.findIndex(function (e) {\n        return e.id === id;\n      });\n      this.selected.splice(idx, 1);\n    },\n    attemptChanges: function attemptChanges() {\n      var _this2 = this;\n\n      var mappedNewSponsors = this.selected.map(function (s) {\n        return s.newSponsor;\n      });\n\n      if (mappedNewSponsors.indexOf(undefined) > -1) {\n        this.error = true;\n        return null;\n      }\n\n      this.locked = true;\n      var changes = this.selected.map(function (e) {\n        return {\n          memberId: e.member.id,\n          sponsorId: e.newSponsor.id\n        };\n      });\n      var tenantId = this.$store.state.user.principal.tenantId;\n      this.$apollo.mutate({\n        mutation: CHANGE_SPONSOR,\n        variables: {\n          input: {\n            changes: {\n              changes: changes\n            },\n            tenantId: tenantId\n          }\n        },\n        update: function () {\n          var _update = _asyncToGenerator(\n          /*#__PURE__*/\n          regeneratorRuntime.mark(function _callee(store, _ref3) {\n            var members;\n            return regeneratorRuntime.wrap(function _callee$(_context) {\n              while (1) {\n                switch (_context.prev = _context.next) {\n                  case 0:\n                    members = _ref3.data.changeSponsors.members;\n                    _this2.selected = [];\n\n                    _this2.close({\n                      message: \"Successfully updated the sponsor for \".concat(members.length, \" member(s)\")\n                    });\n\n                    _this2.reset();\n\n                    _this2.locked = false;\n\n                  case 5:\n                  case \"end\":\n                    return _context.stop();\n                }\n              }\n            }, _callee);\n          }));\n\n          function update(_x, _x2) {\n            return _update.apply(this, arguments);\n          }\n\n          return update;\n        }()\n      }).catch(function (error) {\n        _this2.close({\n          message: \"There was a problem updating the sponsor. Please contact customer support\"\n        });\n\n        _this2.reset();\n\n        _this2.locked = false;\n        console.error(error);\n        throw new Error(error);\n      });\n    },\n    close: function close() {\n      var config = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      this.$emit('close', config);\n      this.reset();\n    },\n    reset: function reset() {\n      var selectedBuffer = [this.defaultMember];\n      Object.assign(this, defaultData);\n      this.selected = selectedBuffer;\n    }\n  },\n  watch: {\n    defaultMember: function defaultMember(newVal, oldVal) {\n      var selectedBuffer = [newVal];\n      this.selected = selectedBuffer;\n    }\n  }\n};",{"version":3,"sources":["ChangeSponsorDialog.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAsFA,OAAA,YAAA,MAAA,2BAAA;AACA,SAAA,IAAA,EAAA,IAAA,QAAA,eAAA;AACA,OAAA,cAAA,MAAA,6BAAA;AAEA,IAAA,cAAA;AACA,MAAA,CADA;AAEA,YAAA,EAFA;AAGA,QAAA,SAHA;AAIA,YAAA;AACA,UAAA,KADA;AAEA,aAAA;AAFA,GAJA;AAQA,UAAA,KARA;AASA,YAAA,KATA;AAUA,SAAA;AAVA,CAAA;AAYA,eAAA;AACA,SAAA;AACA,aAAA,OADA;AAEA,mBAAA;AAFA,GADA;AAKA,QAAA,eALA;AAMA,cAAA;AACA,8BADA;AAEA,cAFA;AAGA;AAHA,GANA;AAWA,MAXA,kBAWA;AACA,6BACA,WADA;AAEA,eAAA,CACA;AAAA,cAAA,IAAA;AAAA,eAAA;AAAA,OADA,EAEA;AAAA,cAAA,QAAA;AAAA,eAAA;AAAA,OAFA,EAGA;AAAA,cAAA,iBAAA;AAAA,eAAA;AAAA,OAHA,EAIA;AAAA,cAAA,aAAA;AAAA,eAAA;AAAA,OAJA,EAKA;AAAA,cAAA,EAAA;AAAA,eAAA;AAAA,OALA;AAFA;AAUA,GAtBA;AAuBA,WAAA;AACA,gBADA,wBACA,CADA,EACA;AACA,WAAA,KAAA,GAAA,KAAA;AACA,WAAA,QAAA,GAAA,IAAA;AACA,KAJA;AAKA,oBALA,4BAKA,CALA,EAKA;AACA,WAAA,QAAA,GAAA,KAAA;AACA,KAPA;AAQA,cARA,sBAQA,IARA,EAQA;AAAA;;AACA,UAAA,MAAA,KAAA,QAAA,CAAA,SAAA,CAAA;AAAA,eAAA,EAAA,EAAA,KAAA,MAAA,IAAA;AAAA,OAAA,CAAA;AACA,WAAA,IAAA,GAAA,SAAA;;AACA,UAAA,4BACA,KAAA,QAAA,CAAA,GAAA,CADA;AAEA,oBAAA,KAAA;AAFA,QAAA;;AAIA,WAAA,QAAA,CAAA,MAAA,CAAA,GAAA,EAAA,CAAA,EAAA,OAAA;AACA,KAhBA;AAiBA,iBAjBA,+BAiBA;AAAA,UAAA,MAAA,QAAA,MAAA;AACA,WAAA,IAAA,GAAA,SAAA;AACA,UAAA,UAAA,IAAA;;AACA,UAAA,UAAA,OAAA,MAAA,IAAA,OAAA,MAAA,CAAA,MAAA,GAAA,CAAA,EAAA;AACA,kBAAA,OAAA,MAAA,CAAA,OAAA,MAAA,CAAA,MAAA,GAAA,CAAA,CAAA;AACA;;AACA,WAAA,QAAA,CAAA,IAAA,CAAA;AACA,YAAA,KAAA,EAAA,EADA;AAEA,sBAFA;AAGA,wBAHA;AAIA,oBAAA;AAJA,OAAA;AAMA,KA7BA;AA8BA,gBA9BA,+BA8BA;AAAA,UAAA,EAAA,SAAA,EAAA;AACA,UAAA,MAAA,KAAA,QAAA,CAAA,SAAA,CAAA;AAAA,eAAA,EAAA,EAAA,KAAA,EAAA;AAAA,OAAA,CAAA;AACA,WAAA,QAAA,CAAA,MAAA,CAAA,GAAA,EAAA,CAAA;AACA,KAjCA;AAkCA,kBAlCA,4BAkCA;AAAA;;AACA,UAAA,oBAAA,KAAA,QAAA,CAAA,GAAA,CAAA;AAAA,eAAA,EAAA,UAAA;AAAA,OAAA,CAAA;;AACA,UAAA,kBAAA,OAAA,CAAA,SAAA,IAAA,CAAA,CAAA,EAAA;AACA,aAAA,KAAA,GAAA,IAAA;AACA,eAAA,IAAA;AACA;;AAEA,WAAA,MAAA,GAAA,IAAA;AAEA,UAAA,UAAA,KAAA,QAAA,CAAA,GAAA,CAAA;AAAA,eAAA;AACA,oBAAA,EAAA,MAAA,CAAA,EADA;AAEA,qBAAA,EAAA,UAAA,CAAA;AAFA,SAAA;AAAA,OAAA,CAAA;AATA,UAaA,QAbA,GAaA,KAAA,MAAA,CAAA,KAAA,CAAA,IAAA,CAAA,SAbA,CAaA,QAbA;AAcA,WAAA,OAAA,CACA,MADA,CACA;AACA,kBAAA,cADA;AAEA,mBAAA;AACA,iBAAA;AAAA,qBAAA;AAAA;AAAA,aAAA;AAAA;AAAA;AADA,SAFA;AAKA;AAAA;AAAA;AAAA,kCAAA,iBAAA,KAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,2BAAA,SAAA,IAAA,CAAA,cAAA,CAAA,OAAA;AACA,2BAAA,QAAA,GAAA,EAAA;;AACA,2BAAA,KAAA,CAAA;AACA,8EACA,QAAA,MADA;AADA,qBAAA;;AAKA,2BAAA,KAAA;;AACA,2BAAA,MAAA,GAAA,KAAA;;AARA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,WAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AALA,OADA,EAiBA,KAjBA,CAiBA,iBAAA;AACA,eAAA,KAAA,CAAA;AACA;AADA,SAAA;;AAGA,eAAA,KAAA;;AACA,eAAA,MAAA,GAAA,KAAA;AACA,gBAAA,KAAA,CAAA,KAAA;AACA,cAAA,IAAA,KAAA,CAAA,KAAA,CAAA;AACA,OAzBA;AA0BA,KA1EA;AA2EA,SA3EA,mBA2EA;AAAA,UAAA,MAAA,uEAAA,EAAA;AACA,WAAA,KAAA,CAAA,OAAA,EAAA,MAAA;AACA,WAAA,KAAA;AACA,KA9EA;AA+EA,SA/EA,mBA+EA;AACA,UAAA,iBAAA,CAAA,KAAA,aAAA,CAAA;AAEA,aAAA,MAAA,CAAA,IAAA,EAAA,WAAA;AACA,WAAA,QAAA,GAAA,cAAA;AACA;AApFA,GAvBA;AA6GA,SAAA;AACA,iBADA,yBACA,MADA,EACA,MADA,EACA;AACA,UAAA,iBAAA,CAAA,MAAA,CAAA;AACA,WAAA,QAAA,GAAA,cAAA;AACA;AAJA;AA7GA,CAAA","sourcesContent":["<template>\n  <v-dialog v-model=\"showing\" :persistent=\"true\" :fullscreen=\"true\">\n    <v-snackbar :timeout=\"8000\" :top=\"true\" :right=\"true\" v-model=\"snackbar.show\">\n      {{snackbar.message}}\n      <v-btn flat color=\"pink\" @click.native=\"snackbar.show = false\">Close</v-btn>\n    </v-snackbar>\n    <v-card>\n      <v-toolbar class=\"black white--text\" primary-title>\n        <v-spacer />\n        <v-toolbar-title>\n          <h1>Change Sponsor</h1>\n        </v-toolbar-title>\n        <v-spacer />\n        <v-tooltip left>\n          <template slot=\"activator\">\n            <v-btn style=\"color: white;\" flat icon @click=\"close\">\n              <v-icon>close</v-icon>\n            </v-btn>\n          </template>\n          <span>Close</span>\n        </v-tooltip>\n      </v-toolbar>\n      <div style=\"padding: 0 25px; margin-top: 25px;\">\n        <p>Use the form below to search for members by name, then drag them by the name to the table below.</p>\n        <v-flex>\n          <MemberSearch\n            @emitDragging=\"emitDragging\"\n            @emitDraggingStop=\"emitDraggingStop\"\n            :draggable=\"true\"\n            @memberSelected=\"childSelected\"\n            :disabled=\"locked\"\n            :defaultMember=\"defaultMember\"\n          />\n        </v-flex>\n        <br />\n        <br />\n        <p>\n          Drop the member below to add them to the list, then drop another member\n          into the \"New Sponsor\" column to update the sponsor.\n        </p>\n        <p>\n          <strong>Warning:</strong> Make sure you're not creating \"cycles\" where a\n          member's sponsor is part of their downline, as the entire operation will fail.\n        </p>\n        <br />\n        <v-data-table :headers=\"headers\" :items=\"selected\" hide-actions class=\"elevation-1\">\n          <template v-if=\"Object.keys(props.item).length\" slot=\"items\" slot-scope=\"props\">\n            <td>{{ props.item.member.id }}</td>\n            <td>{{ props.item.member.name }}</td>\n            <td>{{ props.item.sponsor ? props.item.sponsor.displayName : '' }}</td>\n            <td class=\"dropcol\">\n              <drop\n                class=\"drop\"\n                :class=\"{ over: over == props.item.id, dragging: dragging, error: error }\"\n                @dragover=\"over = props.item.id\"\n                @dragleave=\"over = undefined\"\n                @drop=\"handleDrop\"\n              >{{ props.item.newSponsor ? props.item.newSponsor.displayName : 'Drop a new Sponsor here' }}</drop>\n            </td>\n            <td>\n              <a @click=\"childRemoved(props.item)\" :disabled=\"locked\">Delete</a>\n            </td>\n          </template>\n          <template slot=\"no-data\">\n            <td colspan=\"4\" style=\"display: none\"></td>\n          </template>\n          <template slot=\"footer\">\n            <td colspan=\"4\" class=\"dropcol\">\n              <drop\n                class=\"drop\"\n                :class=\"{ dragging, over: over == -1 }\"\n                @dragover=\"over = -1\"\n                @dragleave=\"over = undefined\"\n                @drop=\"childSelected\"\n              >Drop a member here to change their sponsor</drop>\n            </td>\n          </template>\n        </v-data-table>\n      </div>\n      <v-card-actions class=\"px-4 pt-5\">\n        <v-btn color=\"secondary\" @click=\"attemptChanges\" :disabled=\"locked\">Persist Changes</v-btn>\n      </v-card-actions>\n    </v-card>\n  </v-dialog>\n</template>\n<script>\nimport MemberSearch from '@/components/MemberSearch'\nimport { Drag, Drop } from 'vue-drag-drop'\nimport CHANGE_SPONSOR from '@/graphql/ChangeSponsor.gql'\n\nconst defaultData = {\n  id: 2,\n  selected: [],\n  over: undefined,\n  snackbar: {\n    show: false,\n    message: undefined\n  },\n  locked: false,\n  dragging: false,\n  error: false\n}\nexport default {\n  props: {\n    showing: Boolean,\n    defaultMember: Object\n  },\n  name: 'SponsorDialog',\n  components: {\n    MemberSearch,\n    Drag,\n    Drop\n  },\n  data () {\n    return {\n      ...defaultData,\n      headers: [\n        { text: 'ID', value: 'id' },\n        { text: 'Member', value: 'displayName' },\n        { text: 'Current Sponsor', value: 'currentSponsor' },\n        { text: 'New Sponsor', value: 'newSponsor' },\n        { text: '', value: 'actions' }\n      ]\n    }\n  },\n  methods: {\n    emitDragging (e) {\n      this.error = false\n      this.dragging = true\n    },\n    emitDraggingStop (e) {\n      this.dragging = false\n    },\n    handleDrop (data) {\n      const idx = this.selected.findIndex(e => e.id === this.over)\n      this.over = undefined\n      const updated = {\n        ...this.selected[idx],\n        newSponsor: data.member\n      }\n      this.selected.splice(idx, 1, updated)\n    },\n    childSelected ({ member }) {\n      this.over = undefined\n      let sponsor = null\n      if (member && member.upline && member.upline.length > 1) {\n        sponsor = member.upline[member.upline.length - 2]\n      }\n      this.selected.push({\n        id: this.id++,\n        member,\n        sponsor,\n        newSponsor: undefined\n      })\n    },\n    childRemoved ({ id }) {\n      const idx = this.selected.findIndex(e => e.id === id)\n      this.selected.splice(idx, 1)\n    },\n    attemptChanges () {\n      const mappedNewSponsors = this.selected.map(s => s.newSponsor)\n      if (mappedNewSponsors.indexOf(undefined) > -1) {\n        this.error = true\n        return null\n      }\n\n      this.locked = true\n\n      const changes = this.selected.map(e => ({\n        memberId: e.member.id,\n        sponsorId: e.newSponsor.id\n      }))\n      const { tenantId } = this.$store.state.user.principal\n      this.$apollo\n        .mutate({\n          mutation: CHANGE_SPONSOR,\n          variables: {\n            input: { changes: { changes }, tenantId }\n          },\n          update: async (store, { data: { changeSponsors: { members } } }) => {\n            this.selected = []\n            this.close({\n              message: `Successfully updated the sponsor for ${\n                members.length\n              } member(s)`\n            })\n            this.reset()\n            this.locked = false\n          }\n        })\n        .catch(error => {\n          this.close({\n            message: `There was a problem updating the sponsor. Please contact customer support`\n          })\n          this.reset()\n          this.locked = false\n          console.error(error)\n          throw new Error(error)\n        })\n    },\n    close (config = {}) {\n      this.$emit('close', config)\n      this.reset()\n    },\n    reset () {\n      const selectedBuffer = [this.defaultMember]\n\n      Object.assign(this, defaultData)\n      this.selected = selectedBuffer\n    }\n  },\n  watch: {\n    defaultMember(newVal, oldVal) {\n      const selectedBuffer = [newVal]\n      this.selected = selectedBuffer\n    }\n  }\n}\n</script>\n\n<style>\ntd.dropcol .drop {\n  padding: 12px 24px;\n}\n.drop {\n  transition: all 500ms ease-in;\n}\n.drop.over {\n  color: white;\n  background: #1976d2 !important;\n  transition: all 500ms ease-in;\n}\n.drop.dragging {\n  color: white;\n  background: #78a3cd;\n  transition: all 250ms ease-in;\n}\n.drop.error {\n  color: white;\n  background: red;\n  transition: all 250ms ease-in;\n}\ntd.dropcol {\n  padding: 0px !important;\n}\n</style>\n"],"sourceRoot":"src/components"}]}